<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jupiter Swapper (Affiliate Referral)</title>
  <script src="https://unpkg.com/@solana/web3.js@1.95.1/lib/index.iife.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #0b0e11; color: #eaeaea; text-align: center; padding: 2rem; }
    input, select, button { margin: 0.5rem; padding: 0.6rem; font-size: 1rem; border-radius: 8px; border: none; }
    button { background: #6366f1; color: white; cursor: pointer; }
    button:hover { background: #4f46e5; }
    button:disabled { background: #4b5563; cursor: not-allowed; }
    .row { margin-top: 1rem; }
    a { color: #818cf8; }
    .info { background: #1e293b; padding: 1rem; border-radius: 8px; margin: 1rem auto; max-width: 600px; font-size: 0.9rem; }
    .fee-controls {
      background: #1e293b;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem auto;
      max-width: 600px;
    }
    .fee-display {
      font-size: 1.5rem;
      font-weight: bold;
      color: #818cf8;
      margin: 0.5rem 0;
    }
    input[type="number"].fee-input {
      width: 100px;
      text-align: center;
      background: #0b0e11;
      color: #eaeaea;
      border: 2px solid #4f46e5;
    }
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    #status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      min-height: 20px;
    }
    .error { color: #ef4444; }
    .success { color: #10b981; }
    .warning { color: #f59e0b; background: #1e293b; padding: 1rem; border-radius: 8px; margin: 1rem auto; max-width: 600px; }
    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      max-width: 600px;
      margin: 1rem auto;
    }
    .debug { background: #1e293b; padding: 1rem; border-radius: 8px; margin: 1rem auto; max-width: 600px; font-size: 0.85rem; text-align: left; }
  </style>
</head>
<body>
  <h1>Jupiter Swapper (Affiliate Tracking)</h1>

  <div class="info">
    <p><strong>üîó Affiliate Referral Vault:</strong></p>
    <p style="font-size: 0.8rem; word-break: break-all;">45ruCyfdRkWpRNGEqWzjCiXRHkZs8WXCLQ67Pnpye7Hp</p>
    <div style="margin-top: 1rem;">
      <label>
        <input type="checkbox" id="useReferral" checked />
        Enable Referral Fee Account (uncheck if swaps fail)
      </label>
    </div>
  </div>

  <!-- Fee & Slippage Controls -->
  <div class="controls-grid">
    <div class="fee-controls">
      <p><strong>üí∞ Platform Fee</strong></p>
      <div class="fee-display">
        <span id="feePercent">0.85</span>%
      </div>
      <input type="number" id="feeInput" class="fee-input" min="0" max="1000" value="85" step="5" />
      <p style="font-size: 0.8rem; color: #94a3b8;">bps (85 = 0.85%)</p>
    </div>

    <div class="fee-controls">
      <p><strong>üìä Slippage</strong></p>
      <div class="fee-display">
        <span id="slippagePercent">1.00</span>%
      </div>
      <input type="number" id="slippageInput" class="fee-input" min="10" max="5000" value="100" step="50" />
      <p style="font-size: 0.8rem; color: #94a3b8;">bps (100 = 1%)</p>
    </div>
  </div>

  <div class="row">
    <label>From:</label>
    <select id="inputMint">
      <option value="So11111111111111111111111111111111111111112">SOL</option>
      <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
      <option value="Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB">USDT</option>
    </select>
  </div>

  <div class="row">
    <label>To:</label>
    <select id="outputMint">
      <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
      <option value="Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB">USDT</option>
      <option value="So11111111111111111111111111111111111111112">SOL</option>
    </select>
  </div>

  <div class="row">
    <label>Amount:</label>
    <input id="amount" type="number" placeholder="Enter amount" step="0.01" />
  </div>

  <p id="balance">Balance: ‚Äî</p>
  <p id="estimate">Estimated output: ‚Äî</p>

  <button id="connect">Connect Wallet</button>
  <button id="swap" disabled>Swap</button>

  <p id="status"></p>
  <div id="debug" class="debug" style="display: none;"></div>

  <script>
    const REFERRAL_ACCOUNT = "45ruCyfdRkWpRNGEqWzjCiXRHkZs8WXCLQ67Pnpye7Hp";
    const REFERRAL_PROGRAM_ID = "REFER4ZgmyYx9c6He5XfaTMiGfdLwRnkV4RPp9t9iF3";
    
    const RPC_ENDPOINTS = [
      "https://mainnet.helius-rpc.com/?api-key=public",
      "https://api.mainnet-beta.solana.com",
      "https://solana-api.projectserum.com"
    ];
    
    let currentRpcIndex = 0;
    let connection = new solanaWeb3.Connection(RPC_ENDPOINTS[currentRpcIndex], 'confirmed');
    
    let walletPublicKey = null;
    let isWalletConnected = false;

    const TOKEN_DECIMALS = {
      "So11111111111111111111111111111111111111112": 9,
      "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v": 6,
      "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB": 6,
    };

    // Fee management - lower default to 85 bps (0.85%)
    let platformFeeBps = parseInt(localStorage.getItem("platformFeeBps")) || 85;
    document.getElementById("feeInput").value = platformFeeBps;
    
    function updateFeeDisplay(bps) {
      document.getElementById("feePercent").textContent = (bps / 100).toFixed(2);
    }
    updateFeeDisplay(platformFeeBps);
    
    document.getElementById("feeInput").addEventListener("input", (e) => {
      platformFeeBps = parseInt(e.target.value) || 85;
      localStorage.setItem("platformFeeBps", platformFeeBps);
      updateFeeDisplay(platformFeeBps);
      getEstimate();
    });

    // Slippage management
    let slippageBps = parseInt(localStorage.getItem("slippageBps")) || 100;
    document.getElementById("slippageInput").value = slippageBps;
    
    function updateSlippageDisplay(bps) {
      document.getElementById("slippagePercent").textContent = (bps / 100).toFixed(2);
    }
    updateSlippageDisplay(slippageBps);
    
    document.getElementById("slippageInput").addEventListener("input", (e) => {
      slippageBps = parseInt(e.target.value) || 100;
      localStorage.setItem("slippageBps", slippageBps);
      updateSlippageDisplay(slippageBps);
      getEstimate();
    });

    function debugLog(message) {
      const debugDiv = document.getElementById("debug");
      debugDiv.style.display = "block";
      debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
      console.log(message);
    }

    // Browser-compatible Buffer polyfill
    function stringToBuffer(str) {
      const encoder = new TextEncoder();
      return encoder.encode(str);
    }

    async function getReferralTokenAccount(outputMint) {
      try {
        const referralAccountPubkey = new solanaWeb3.PublicKey(REFERRAL_ACCOUNT);
        const mintPubkey = new solanaWeb3.PublicKey(outputMint);
        const referralProgramId = new solanaWeb3.PublicKey(REFERRAL_PROGRAM_ID);
        
        const [referralTokenAccount] = solanaWeb3.PublicKey.findProgramAddressSync(
          [
            stringToBuffer("referral_ata"),
            referralAccountPubkey.toBuffer(),
            mintPubkey.toBuffer()
          ],
          referralProgramId
        );
        
        const address = referralTokenAccount.toBase58();
        debugLog(`Referral token account: ${address}`);
        
        // Check if account exists
        try {
          const accountInfo = await connection.getAccountInfo(referralTokenAccount);
          if (accountInfo) {
            debugLog(`‚úÖ Referral account exists`);
          } else {
            debugLog(`‚ö†Ô∏è Referral account does not exist yet`);
          }
        } catch (err) {
          debugLog(`‚ö†Ô∏è Could not verify referral account: ${err.message}`);
        }
        
        return address;
      } catch (err) {
        debugLog(`‚ùå Error deriving referral account: ${err.message}`);
        return null;
      }
    }

    async function retryRpcCall(fn, maxRetries = 2) {
      for (let i = 0; i <= maxRetries; i++) {
        try {
          return await fn();
        } catch (err) {
          console.error(`RPC call failed (attempt ${i + 1}):`, err);
          if (i < maxRetries && err.message?.includes('403')) {
            currentRpcIndex = (currentRpcIndex + 1) % RPC_ENDPOINTS.length;
            connection = new solanaWeb3.Connection(RPC_ENDPOINTS[currentRpcIndex], 'confirmed');
            console.log(`Switching to RPC: ${RPC_ENDPOINTS[currentRpcIndex]}`);
            await new Promise(resolve => setTimeout(resolve, 1000));
          } else {
            throw err;
          }
        }
      }
    }

    async function connectWallet() {
      try {
        if (!window.solana) {
          alert("‚ö†Ô∏è Solana wallet not detected!\n\nPlease install:\n- Phantom Wallet\n- Solflare\n- Or another Solana wallet extension");
          return;
        }

        document.getElementById("status").innerText = "üîÑ Requesting wallet connection...";
        
        if (window.solana.isConnected && window.solana.publicKey) {
          walletPublicKey = window.solana.publicKey.toBase58();
          isWalletConnected = true;
          document.getElementById("status").innerHTML = `‚úÖ Already connected: <strong>${walletPublicKey.slice(0, 4)}...${walletPublicKey.slice(-4)}</strong>`;
          document.getElementById("connect").innerText = "Disconnect";
          document.getElementById("swap").disabled = false;
          await updateBalance();
          return;
        }

        console.log("Requesting wallet connection...");
        const resp = await window.solana.connect();
        
        if (!resp || !resp.publicKey) {
          throw new Error("No public key returned from wallet");
        }
        
        walletPublicKey = resp.publicKey.toBase58();
        isWalletConnected = true;
        
        console.log("Wallet connected:", walletPublicKey);
        document.getElementById("status").innerHTML = `‚úÖ Connected: <strong>${walletPublicKey.slice(0, 4)}...${walletPublicKey.slice(-4)}</strong>`;
        document.getElementById("connect").innerText = "Disconnect";
        document.getElementById("swap").disabled = false;
        await updateBalance();
        
      } catch (err) {
        console.error("Connection error:", err);
        isWalletConnected = false;
        document.getElementById("swap").disabled = true;
        
        if (err.code === 4001 || err.message?.includes("User rejected")) {
          document.getElementById("status").innerHTML = `<span class="error">‚ùå Connection rejected by user</span>`;
        } else if (err.code === -32603) {
          document.getElementById("status").innerHTML = `<span class="error">‚ùå Wallet is locked. Please unlock your wallet and try again.</span>`;
        } else {
          document.getElementById("status").innerHTML = `<span class="error">‚ùå Connection failed: ${err.message}</span>`;
        }
      }
    }

    async function disconnectWallet() {
      try {
        if (window.solana && window.solana.isConnected) {
          await window.solana.disconnect();
        }
        walletPublicKey = null;
        isWalletConnected = false;
        document.getElementById("status").innerText = "Disconnected";
        document.getElementById("connect").innerText = "Connect Wallet";
        document.getElementById("swap").disabled = true;
        document.getElementById("balance").innerText = "Balance: ‚Äî";
        document.getElementById("estimate").innerText = "Estimated output: ‚Äî";
      } catch (err) {
        console.error("Disconnect error:", err);
        walletPublicKey = null;
        isWalletConnected = false;
        document.getElementById("connect").innerText = "Connect Wallet";
        document.getElementById("swap").disabled = true;
      }
    }

    async function updateBalance() {
      if (!walletPublicKey) return;
      const mint = document.getElementById("inputMint").value;
      let balanceUI = 0;

      try {
        if (mint === "So11111111111111111111111111111111111111112") {
          const solBalance = await retryRpcCall(async () => {
            return await connection.getBalance(new solanaWeb3.PublicKey(walletPublicKey));
          });
          balanceUI = solBalance / 1e9;
        } else {
          const tokenAccounts = await retryRpcCall(async () => {
            return await connection.getParsedTokenAccountsByOwner(
              new solanaWeb3.PublicKey(walletPublicKey),
              { mint: new solanaWeb3.PublicKey(mint) }
            );
          });
          if (tokenAccounts.value.length > 0) {
            balanceUI = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
          }
        }
        document.getElementById("balance").innerText = `Balance: ${balanceUI.toFixed(6)}`;
      } catch (err) {
        console.error("Balance fetch error:", err);
        document.getElementById("balance").innerText = `Balance: Error (RPC issue)`;
      }
    }

    async function getEstimate() {
      const inputMint = document.getElementById("inputMint").value;
      const outputMint = document.getElementById("outputMint").value;
      const uiAmount = parseFloat(document.getElementById("amount").value);
      
      if (!uiAmount || uiAmount <= 0) {
        document.getElementById("estimate").innerText = "Estimated output: ‚Äî";
        return;
      }

      const decimals = TOKEN_DECIMALS[inputMint] || 6;
      const amount = Math.floor(uiAmount * 10 ** decimals);
      
      try {
        const useReferral = document.getElementById("useReferral").checked;
        const feeParam = useReferral ? `&platformFeeBps=${platformFeeBps}` : '';
        
        const quote = await fetch(
          `https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${slippageBps}${feeParam}`
        ).then(r => {
          if (!r.ok) throw new Error(`Quote failed: ${r.statusText}`);
          return r.json();
        });

        const outDecimals = TOKEN_DECIMALS[outputMint] || 6;
        const estOut = quote.outAmount / 10 ** outDecimals;
        document.getElementById("estimate").innerText = `Estimated output: ‚âà ${estOut.toFixed(6)}`;
      } catch (err) {
        console.error("Estimate error:", err);
        document.getElementById("estimate").innerText = "Estimated output: ‚Äî";
      }
    }

    function parseJupiterError(errorMessage) {
      if (errorMessage.includes('0x1789')) {
        return 'üî¥ Slippage tolerance exceeded or referral account issue!\n\nüí° Try:\n‚Ä¢ Unchecking "Enable Referral Fee Account"\n‚Ä¢ Increasing slippage\n‚Ä¢ Using a smaller amount';
      }
      if (errorMessage.includes('0x1')) {
        return '‚ùå Insufficient balance or account not found';
      }
      if (errorMessage.includes('0x0')) {
        return '‚ùå Insufficient liquidity for this swap';
      }
      return errorMessage;
    }

    async function swap() {
      const inputMint = document.getElementById("inputMint").value;
      const outputMint = document.getElementById("outputMint").value;
      const uiAmount = parseFloat(document.getElementById("amount").value);
      
      if (!walletPublicKey || !isWalletConnected) {
        alert("Please connect your wallet first");
        return;
      }
      
      if (!uiAmount || uiAmount <= 0) {
        alert("Please enter a valid amount");
        return;
      }

      // Clear debug log
      document.getElementById("debug").innerHTML = "<strong>Debug Log:</strong><br>";
      document.getElementById("debug").style.display = "block";

      const decimals = TOKEN_DECIMALS[inputMint] || 6;
      const amount = Math.floor(uiAmount * 10 ** decimals);
      document.getElementById("status").innerText = "üîÑ Fetching fresh quote...";
      document.getElementById("swap").disabled = true;

      try {
        const useReferral = document.getElementById("useReferral").checked;
        debugLog(`Using referral: ${useReferral}`);
        debugLog(`Platform fee: ${platformFeeBps} bps (${(platformFeeBps/100).toFixed(2)}%)`);
        debugLog(`Slippage: ${slippageBps} bps (${(slippageBps/100).toFixed(2)}%)`);
        
        const feeParam = useReferral ? `&platformFeeBps=${platformFeeBps}` : '';
        
        // Get fresh quote using v6 API
        debugLog(`Fetching quote from Jupiter v6 API...`);
        const quote = await fetch(
          `https://quote-api.jup.ag/v6/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${slippageBps}${feeParam}`
        ).then(r => {
          if (!r.ok) throw new Error(`Quote failed: ${r.statusText}`);
          return r.json();
        });
        
        debugLog(`Quote received: ${quote.outAmount}`);

        let feeAccount = null;
        if (useReferral) {
          feeAccount = await getReferralTokenAccount(outputMint);
          if (!feeAccount) {
            debugLog(`‚ö†Ô∏è Could not derive referral account, proceeding without it`);
          }
        }
        
        document.getElementById("status").innerText = "üìù Preparing swap transaction...";

        const swapBody = {
          userPublicKey: walletPublicKey,
          quoteResponse: quote,
          wrapAndUnwrapSol: true,
          computeUnitPriceMicroLamports: "auto",
          dynamicComputeUnitLimit: true,
        };

        // Only add feeAccount if we have one and user enabled it
        if (feeAccount && useReferral) {
          swapBody.feeAccount = feeAccount;
          debugLog(`Including fee account: ${feeAccount}`);
        } else {
          debugLog(`No fee account included in swap`);
        }

        debugLog(`Calling Jupiter swap API...`);
        const swapRes = await fetch("https://quote-api.jup.ag/v6/swap", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(swapBody),
        }).then(r => {
          if (!r.ok) throw new Error(`Swap API failed: ${r.statusText}`);
          return r.json();
        });

        debugLog(`Transaction prepared, requesting signature...`);
        document.getElementById("status").innerText = "‚úçÔ∏è Please sign the transaction in your wallet...";
        const tx = swapRes.swapTransaction;
        
        // Use Uint8Array instead of Buffer
        const txBytes = Uint8Array.from(atob(tx), c => c.charCodeAt(0));
        const versionedTx = solanaWeb3.VersionedTransaction.deserialize(txBytes);
        const signedTx = await window.solana.signTransaction(versionedTx);
        
        debugLog(`Transaction signed, sending...`);
        document.getElementById("status").innerText = "üì° Sending transaction...";
        const sig = await connection.sendRawTransaction(signedTx.serialize(), {
          skipPreflight: false,
          maxRetries: 2
        });
        
        debugLog(`Transaction sent: ${sig}`);
        document.getElementById("status").innerHTML =
          `‚úÖ Swap sent: <a href="https://solscan.io/tx/${sig}" target="_blank">${sig.slice(0, 8)}...</a><br>` +
          `Fee: ${useReferral ? (platformFeeBps/100).toFixed(2) + '%' : 'None'} | Slippage: ${(slippageBps/100).toFixed(2)}%<br>‚è≥ Waiting for confirmation...`;

        await connection.confirmTransaction(sig, "confirmed");
        debugLog(`‚úÖ Transaction confirmed!`);
        await updateBalance();
        document.getElementById("status").innerHTML += useReferral ? 
          "<br>üéâ Confirmed! Swap counted toward affiliate vault." :
          "<br>üéâ Confirmed!";
      } catch (err) {
        console.error("Swap error:", err);
        debugLog(`‚ùå Error: ${err.message}`);
        const friendlyError = parseJupiterError(err.message);
        document.getElementById("status").innerHTML = `<span class="error">${friendlyError}</span>`;
      } finally {
        document.getElementById("swap").disabled = false;
      }
    }

    // Event listeners
    document.getElementById("connect").onclick = () => {
      if (isWalletConnected) {
        disconnectWallet();
      } else {
        connectWallet();
      }
    };
    
    document.getElementById("swap").onclick = swap;
    document.getElementById("inputMint").onchange = async () => { 
      await updateBalance(); 
      await getEstimate(); 
    };
    document.getElementById("outputMint").onchange = getEstimate;
    document.getElementById("amount").oninput = getEstimate;
    document.getElementById("useReferral").onchange = getEstimate;

    // Wallet event listeners
    if (window.solana) {
      window.solana.on('connect', (publicKey) => {
        console.log('Wallet connected event:', publicKey.toBase58());
        if (!isWalletConnected) {
          walletPublicKey = publicKey.toBase58();
          isWalletConnected = true;
          document.getElementById("connect").innerText = "Disconnect";
          document.getElementById("swap").disabled = false;
          updateBalance();
        }
      });
      
      window.solana.on('disconnect', () => {
        console.log('Wallet disconnected event');
        walletPublicKey = null;
        isWalletConnected = false;
        document.getElementById("connect").innerText = "Connect Wallet";
        document.getElementById("swap").disabled = true;
        document.getElementById("status").innerText = "Wallet disconnected";
        document.getElementById("balance").innerText = "Balance: ‚Äî";
      });

      window.solana.on('accountChanged', (publicKey) => {
        if (publicKey) {
          console.log('Account changed:', publicKey.toBase58());
          walletPublicKey = publicKey.toBase58();
          document.getElementById("status").innerHTML = `‚úÖ Account changed: <strong>${walletPublicKey.slice(0, 4)}...${walletPublicKey.slice(-4)}</strong>`;
          updateBalance();
        } else {
          disconnectWallet();
        }
      });

      // Auto-connect if previously connected
      setTimeout(() => {
        if (window.solana.isConnected && window.solana.publicKey) {
          console.log('Auto-connecting to wallet...');
          connectWallet();
        }
      }, 500);
    } else {
      console.warn('No Solana wallet detected');
      document.getElementById("status").innerHTML = '<span class="error">‚ö†Ô∏è No Solana wallet detected. Please install Phantom or Solflare.</span>';
    }
  </script>
</body>
</html>